<!DOCTYPE html>
<html>
<head>
    <title>TFJS Chess Engine</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; }
        #board { width: 400px; margin: 20px; border: 5px solid #34495e; border-radius: 5px; }
        #status { font-weight: bold; margin-bottom: 10px; height: 30px; color: #f1c40f; }
        #error-log { color: #e74c3c; font-size: 12px; max-width: 400px; text-align: center; }
        .btn { padding: 10px 20px; background: #e67e22; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>My AI Chess Engine</h1>
    <div id="status">Initializing...</div>
    <div id="board"></div>
    <div id="error-log"></div>
    <button class="btn" onclick="resetGame()">Reset Game</button>

    <script>
        let board = null;
        let game = new Chess(); 
        let model = null;
        let isFrozen = false; 

        async function loadModel() {
            try {
                $('#status').text('Loading Brain...');
                // Debug: print the URL we are trying to fetch
                console.log("Fetching model from: ./model/model.json");
                
                model = await tf.loadLayersModel('./model/model.json');
                
                $('#status').text('Model Loaded! Your Turn (White).');
                $('#error-log').text(''); // Clear errors
            } catch (e) {
                // SHOW THE REAL ERROR ON SCREEN
                $('#status').text('Critical Error');
                $('#error-log').html(`<b>Detailed Error:</b><br>${e.message}`);
                console.error(e);
            }
        }
        loadModel();

        const pieceToLayer = {
            'P': 0, 'N': 1, 'B': 2, 'R': 3, 'Q': 4, 'K': 5,
            'p': 6, 'n': 7, 'b': 8, 'r': 9, 'q': 10, 'k': 11
        };

        function boardToMatrix(chessInstance) {
            const matrix = new Float32Array(8 * 8 * 12).fill(0);
            const boardConfig = chessInstance.board(); 
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = boardConfig[r][c];
                    if (piece) {
                        let symbol = piece.type; 
                        if (piece.color === 'w') symbol = symbol.toUpperCase();
                        const layer = pieceToLayer[symbol];
                        const pythonRow = 7 - r; 
                        const index = (pythonRow * 8 + c) * 12 + layer;
                        matrix[index] = 1;
                    }
                }
            }
            return tf.tensor4d(matrix, [1, 8, 8, 12]);
        }

        async function makeBestMove() {
            if (game.game_over()) return;
            
            const moves = game.moves();
            if (moves.length === 0) {
                $('#status').text('Game Over');
                return;
            }

            if (!model) {
                // Fallback if model is broken but user keeps playing
                const randomMove = moves[Math.floor(Math.random() * moves.length)];
                game.move(randomMove);
                board.position(game.fen());
                $('#status').text('Your Turn (Random Move)');
                isFrozen = false;
                return;
            }

            let bestMove = null;
            let bestScore = Infinity; 

            for (let i = 0; i < moves.length; i++) {
                game.move(moves[i]);
                const inputTensor = boardToMatrix(game);
                const prediction = model.predict(inputTensor);
                const score = (await prediction.data())[0];
                inputTensor.dispose();
                prediction.dispose();

                if (score < bestScore) {
                    bestScore = score;
                    bestMove = moves[i];
                }
                game.undo();
            }

            if (bestMove) {
                game.move(bestMove);
                board.position(game.fen());
                $('#status').text('Your Turn');
            }
            isFrozen = false;
            if (game.game_over()) $('#status').text('Game Over');
        }

        function onDragStart(source, piece) {
            if (isFrozen || game.game_over() || piece.search(/^b/) !== -1) return false;
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            isFrozen = true;
            $('#status').text('AI Thinking...');
            window.setTimeout(makeBestMove, 50);
        }

        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);

        function resetGame() {
            game = new Chess();
            board.start();
            isFrozen = false;
            $('#status').text('Model Loaded! Your Turn.');
        }
    </script>
</body>
</html>
