<!DOCTYPE html>
<html>
<head>
    <title>TFJS Chess Engine</title>
    <!-- Load libraries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f0f0; }
        #board { width: 400px; margin: 20px; }
        #status { font-weight: bold; margin-bottom: 10px; }
        .btn { padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h1>My AI Chess Engine</h1>
    <div id="status">Loading Model...</div>
    <div id="board"></div>
    <button class="btn" onclick="resetGame()">Reset Game</button>

    <script>
        let board = null;
        let game = new Chess(); // This is the JS equivalent of python-chess
        let model = null;

        // 1. Load the TensorFlow.js Model
        async function loadModel() {
            try {
                // Make sure the path matches where you put your files
                model = await tf.loadLayersModel('./model/model.json');
                $('#status').text('Model Loaded! Your Turn (White).');
            } catch (e) {
                $('#status').text('Error loading model: ' + e);
            }
        }
        loadModel();

        // 2. Helper: Convert Board to 3D Matrix (The hardest part!)
        // We have to replicate your Python 'board_to_matrix' exactly in JS
        const pieceToLayer = {
            'P': 0, 'N': 1, 'B': 2, 'R': 3, 'Q': 4, 'K': 5,
            'p': 6, 'n': 7, 'b': 8, 'r': 9, 'q': 10, 'k': 11
        };

        function boardToMatrix(chessInstance) {
            const matrix = new Float32Array(8 * 8 * 12).fill(0);
            const boardConfig = chessInstance.board(); // Returns 8x8 array

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = boardConfig[r][c];
                    if (piece) {
                        // chess.js uses 'w'/'b' and 'p'/'n'... we need to map to your Python format
                        let symbol = piece.type; 
                        if (piece.color === 'w') symbol = symbol.toUpperCase();
                        
                        // chess.js rows are 0-7 (top to bottom), cols 0-7 (left to right)
                        // We need to map this to the matrix index
                        const layer = pieceToLayer[symbol];
                        
                        // Calculate flat index: (row * 8 + col) * 12 + layer
                        // Note: Double check if your python logic used flip logic. 
                        // Usually standard is Rank 8 = row 0.
                        const index = (r * 8 + c) * 12 + layer;
                        matrix[index] = 1;
                    }
                }
            }
            return tf.tensor4d(matrix, [1, 8, 8, 12]);
        }

        // 3. The AI Logic (Simple Evaluation)
        async function makeBestMove() {
            $('#status').text('AI Thinking...');
            
            // Allow UI to update before freezing
            await new Promise(r => setTimeout(r, 10));

            const moves = game.moves();
            if (moves.length === 0) {
                $('#status').text('Game Over');
                return;
            }

            let bestMove = null;
            let bestScore = Infinity; // Black wants the LOWEST score (negative)

            // Simple greedy search (Depth 1)
            for (let i = 0; i < moves.length; i++) {
                game.move(moves[i]);
                
                // Predict
                const inputTensor = boardToMatrix(game);
                const prediction = model.predict(inputTensor);
                const score = (await prediction.data())[0];
                
                inputTensor.dispose(); // Cleanup memory
                prediction.dispose();

                if (score < bestScore) {
                    bestScore = score;
                    bestMove = moves[i];
                }
                
                game.undo();
            }

            game.move(bestMove);
            board.position(game.fen());
            $('#status').text('Your Turn');
            
            if (game.game_over()) {
                $('#status').text('Game Over');
            }
        }

        // 4. Board Interaction
        function onDragStart(source, piece) {
            if (game.game_over() || piece.search(/^b/) !== -1) return false;
        }

        function onDrop(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            window.setTimeout(makeBestMove, 250);
        }

        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);

        function resetGame() {
            game.reset();
            board.start();
            $('#status').text('Your Turn');
        }
    </script>
</body>
</html>
