<!DOCTYPE html>
<html>
<head>
    <title>TFJS Chess Engine</title>
    <!-- 1. Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- 2. Load Chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <!-- 3. Load Chessboard.js JS -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <!-- 4. Load Chess.js (Specific Version that works) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <!-- 5. Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #2c3e50; color: white; }
        h1 { margin-top: 20px; }
        #board { width: 400px; margin: 20px; border: 5px solid #34495e; border-radius: 5px; }
        #status { font-weight: bold; margin-bottom: 10px; font-size: 1.2em; height: 30px; }
        .btn { padding: 10px 20px; background: #e67e22; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
        .btn:hover { background: #d35400; }
    </style>
</head>
<body>

    <h1>My AI Chess Engine</h1>
    <div id="status">Initializing...</div>
    <div id="board"></div>
    <button class="btn" onclick="resetGame()">Reset Game</button>

    <script>
        let board = null;
        let game = new Chess(); 
        let model = null;
        let isFrozen = false; 

        // --- 1. LOAD MODEL ---
        async function loadModel() {
            try {
                $('#status').text('Loading Brain...');
                // Ensure both model.json AND the .bin file are in the 'model' folder on GitHub
                model = await tf.loadLayersModel('./model/model.json');
                $('#status').text('Model Loaded! You are White.');
            } catch (e) {
                $('#status').text('Error: Could not load model.');
                console.error("Model Load Error:", e);
                alert("Error loading model! Make sure 'group1-shard1of1.bin' is uploaded to the model folder on GitHub.");
            }
        }
        loadModel();

        // --- 2. HELPER FUNCTIONS ---
        const pieceToLayer = {
            'P': 0, 'N': 1, 'B': 2, 'R': 3, 'Q': 4, 'K': 5,
            'p': 6, 'n': 7, 'b': 8, 'r': 9, 'q': 10, 'k': 11
        };

        function boardToMatrix(chessInstance) {
            // Safety check
            if (typeof chessInstance.board !== 'function') {
                console.error("Chess.js object is broken:", chessInstance);
                return null;
            }

            const matrix = new Float32Array(8 * 8 * 12).fill(0);
            const boardConfig = chessInstance.board(); 

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = boardConfig[r][c];
                    if (piece) {
                        let symbol = piece.type; 
                        if (piece.color === 'w') symbol = symbol.toUpperCase();
                        
                        const layer = pieceToLayer[symbol];
                        const pythonRow = 7 - r; // Flip row for Python compatibility
                        const index = (pythonRow * 8 + c) * 12 + layer;
                        
                        matrix[index] = 1;
                    }
                }
            }
            return tf.tensor4d(matrix, [1, 8, 8, 12]);
        }

        async function makeBestMove() {
            if (game.game_over()) return;

            const moves = game.moves();
            if (moves.length === 0) {
                $('#status').text('Game Over');
                return;
            }

            if (!model) {
                console.log("Model not loaded yet, playing random move.");
                const randomMove = moves[Math.floor(Math.random() * moves.length)];
                game.move(randomMove);
                board.position(game.fen());
                isFrozen = false;
                $('#status').text('Your Turn (Model not loaded)');
                return;
            }

            let bestMove = null;
            let bestScore = Infinity; // Black wants to minimize score

            // Evaluate moves
            for (let i = 0; i < moves.length; i++) {
                game.move(moves[i]);
                
                const inputTensor = boardToMatrix(game);
                if (inputTensor) {
                    const prediction = model.predict(inputTensor);
                    const score = (await prediction.data())[0];
                    
                    inputTensor.dispose();
                    prediction.dispose();

                    if (score < bestScore) {
                        bestScore = score;
                        bestMove = moves[i];
                    }
                }
                game.undo();
            }

            if (bestMove) {
                game.move(bestMove);
                board.position(game.fen());
                $('#status').text('Your Turn');
            }
            
            isFrozen = false;
            if (game.game_over()) $('#status').text('Game Over');
        }

        // --- 3. BOARD INTERACTION ---
        function onDragStart(source, piece) {
            if (isFrozen || game.game_over() || piece.search(/^b/) !== -1) return false;
        }

        function onDrop(source, target) {
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            isFrozen = true;
            $('#status').text('AI Thinking...');
            window.setTimeout(makeBestMove, 50);
        }

        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);

        function resetGame() {
            game = new Chess();
            board.start();
            isFrozen = false;
            $('#status').text('Model Loaded! You are White.');
        }
    </script>
</body>
</html>
