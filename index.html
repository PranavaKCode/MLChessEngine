<!DOCTYPE html>
<html>
<head>
    <title>Functional Chess AI</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #dfdfdf; display: flex; flex-direction: column; align-items: center; }
        h1 { margin-top: 10px; color: #4CAF50; }
        #board { width: 400px; margin: 15px; border: 5px solid #333; border-radius: 5px; }
        #status { font-weight: bold; margin-bottom: 10px; height: 30px; font-size: 18px; color: #fff; }
        #debug { font-size: 12px; color: #aaa; margin-top: 5px; font-family: monospace; }
        .btn { padding: 10px 20px; background: #333; color: white; border: 1px solid #555; cursor: pointer; border-radius: 4px; font-size: 16px; margin-top: 10px;}
        .btn:hover { background: #444; }
    </style>
</head>
<body>

    <h1>Functional Chess AI</h1>
    <div id="status">Initializing...</div>
    <div id="board"></div>
    <button class="btn" onclick="resetGame()">New Game</button>
    <div id="debug"></div>

    <script>
        let board = null;
        let game = new Chess(); 
        let model = null;
        let isFrozen = false; 

        // 1. Load the V3 Model
        async function loadModel() {
            try {
                $('#status').text('Loading Brain...');
                // Explicitly pointing to model_v3 to ensure clean load
                model = await tf.loadLayersModel('./model_v3/model.json');
                $('#status').text('AI Ready! You are White.');
                $('#debug').text('Model V3 (Functional API) loaded.');
            } catch (e) {
                $('#status').text('Error loading AI.');
                $('#debug').html(`<span style="color:red">${e.message}</span>`);
                console.error(e);
            }
        }
        loadModel();

        // 2. Matrix Conversion
        const pieceToLayer = {
            'P': 0, 'N': 1, 'B': 2, 'R': 3, 'Q': 4, 'K': 5,
            'p': 6, 'n': 7, 'b': 8, 'r': 9, 'q': 10, 'k': 11
        };

        function boardToMatrix(chessInstance) {
            const matrix = new Float32Array(8 * 8 * 12).fill(0);
            const boardConfig = chessInstance.board(); 
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = boardConfig[r][c];
                    if (piece) {
                        let symbol = piece.type; 
                        if (piece.color === 'w') symbol = symbol.toUpperCase();
                        const layer = pieceToLayer[symbol];
                        const pythonRow = 7 - r; 
                        const index = (pythonRow * 8 + c) * 12 + layer;
                        matrix[index] = 1;
                    }
                }
            }
            return tf.tensor4d(matrix, [1, 8, 8, 12]);
        }

        // 3. Game Status Logic
        function updateStatus() {
            let status = '';
            let moveColor = (game.turn() === 'b') ? 'Black' : 'White';

            if (game.in_checkmate()) {
                status = 'Game Over: ' + moveColor + ' is in checkmate!';
            } else if (game.in_draw()) {
                status = 'Game Over: Draw';
            } else {
                status = moveColor + ' to move';
                if (game.in_check()) {
                    status += ' (CHECK)';
                }
            }
            $('#status').text(status);
        }

        async function makeBestMove() {
            if (game.game_over()) return;

            const moves = game.moves();
            if (moves.length === 0) return;

            let bestMove = null;
            
            if (model) {
                let bestScore = Infinity; // Black wants negative score
                // Evaluate all moves
                for (let i = 0; i < moves.length; i++) {
                    game.move(moves[i]);
                    const inputTensor = boardToMatrix(game);
                    
                    // Predict
                    const prediction = model.predict(inputTensor);
                    const score = (await prediction.data())[0];
                    
                    // Cleanup
                    inputTensor.dispose();
                    prediction.dispose();

                    if (score < bestScore) {
                        bestScore = score;
                        bestMove = moves[i];
                    }
                    game.undo();
                }
            } else {
                // Fallback only if model fails to load
                bestMove = moves[Math.floor(Math.random() * moves.length)];
            }

            if (bestMove) {
                game.move(bestMove);
                board.position(game.fen());
                updateStatus();
            }
            isFrozen = false;
        }

        function onDragStart(source, piece) {
            if (isFrozen || game.game_over() || piece.search(/^b/) !== -1) return false;
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            updateStatus();
            isFrozen = true;
            window.setTimeout(makeBestMove, 50);
        }

        const config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);

        function resetGame() {
            game = new Chess();
            board.start();
            isFrozen = false;
            updateStatus();
            if(model) $('#debug').text('Model V3 Active');
        }
    </script>
</body>
</html>
